version: "3.2"

services:
  php:
    build:
      context: .
      dockerfile: './.docker/php/Dockerfile'
      args:
        UID: ${UID}
        GID: ${GID}
    networks:
      - backend
    volumes:
      - ./config:/var/www/html/config
      - ./templates:/var/www/html/templates
      - ./modules:/var/www/html/modules
      - ./public:/var/www/html/public
      - ./.env:/var/www/html/.env
      - vendor:/var/www/html/vendor # Shared with the composer service. Built packages will be mounted here.

  webserver:
    build:
      context: .
      dockerfile: './.docker/apache/Dockerfile'
    env_file:
      './.docker/apache/.env'
    depends_on:
      - php
      - database
    networks:
      - frontend
      - backend
      - default
    expose:
      - 80
    volumes:
      - ./public:/var/www/html/public

  database:
    image: mariadb:10.3
    env_file:
      './.docker/mariadb/.env'
    volumes:
      - database:/var/lib/mysql
      - ./.docker/mariadb/seed:/docker-entrypoint-initdb.d:ro # Any SQL or SQL.GZ files will be imported into the DB on first container load.
    networks:
      - backend
    labels:
      - db.network.tunnel.hostname=mysite.test

  composer:
    build:
      context: .
      dockerfile: './.docker/composer/Dockerfile'
    volumes:
      - vendor:/app/vendor # Named VOLUME shared with the php service for installed composer packages.
      - ./:/app
    command: "composer install"

  node:
    image: node:8-alpine
    working_dir: /app
    volumes:
      - npm-cache:/root/.npm
      - /app/node_modules
      - ./:/app
    command: yarn

networks:
  default:
    external:
      name: nginx-proxy
  frontend:
  backend:

volumes:
  database:
  vendor:
  npm-cache: